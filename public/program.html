<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Studio + — Program Output</title>
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    html, body { width:100%; height:100%; background:#000; overflow:hidden; }
    canvas { width:100%; height:100%; display:block; object-fit:contain; }
    #waitMsg { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#444; font-family:'Segoe UI',sans-serif; }
    #waitMsg h2 { font-size:1.5rem; letter-spacing:2px; margin-bottom:0.5rem; }
    #waitMsg h2 span { color:#e63; }
    #waitMsg p { font-size:0.85rem; color:#333; }
  </style>
</head>
<body>

<div id="waitMsg">
  <h2>STUDIO <span>+</span></h2>
  <p>Esperando señal del director...</p>
</div>
<canvas id="outputCanvas" style="display:none"></canvas>

<script>
const params   = new URLSearchParams(location.search);
const myRoom   = params.get('room') || '';
const myPass   = params.get('pass') || '';

const STUN = { iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'}
]};

let ws;
// guests en este contexto: Map<guestId, { pc, stream, videoEl }>
const guestStreams = new Map();
let directorStream = null;
let directorVideoEl = null;
let currentLayout = 'grid4';
let onAirIds = [];
let animFrame;

const LAYOUTS = [
  { id:'full',  cols:1, rows:1 },
  { id:'side2', cols:2, rows:1 },
  { id:'grid4', cols:2, rows:2 },
  { id:'grid6', cols:3, rows:2 }
];

// ── RECIBIR MENSAJES DEL DIRECTOR (misma pestaña origen) ──────
window.addEventListener('message', (e) => {
  if (e.origin !== location.origin) return;
  const msg = e.data;
  if (msg.type === 'scene-update') {
    onAirIds = msg.onAirIds || [];
    currentLayout = msg.layout || 'grid4';
  }
});

// ── WEBSOCKET — recibir streams de invitados ──────────────────
function conectar() {
  if (!myRoom) return;
  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${protocol}://${location.host}/signal/${myRoom}?name=Program+Monitor&role=program&password=${encodeURIComponent(myPass)}`);

  ws.onopen = () => console.log('[program] WS conectado');

  ws.onmessage = async ({ data }) => {
    const msg = JSON.parse(data);

    if (msg.type === 'offer') {
      await recibirStream(msg.senderId, msg.senderName, msg.senderRole, msg.offer);
    }
    if (msg.type === 'ice-candidate') {
      const s = guestStreams.get(msg.senderId);
      if (s) { try { await s.pc.addIceCandidate(new RTCIceCandidate(msg.candidate)); } catch(e) {} }
    }
    if (msg.type === 'guest-left') {
      const s = guestStreams.get(msg.guestId);
      if (s) { s.pc?.close(); s.videoEl?.remove(); guestStreams.delete(msg.guestId); }
    }
    if (msg.type === 'force-mute') {
      // silenciar localmente
    }
  };
}

async function recibirStream(senderId, senderName, senderRole, offer) {
  const pc = new RTCPeerConnection(STUN);
  const videoEl = document.createElement('video');
  videoEl.autoplay = true; videoEl.playsinline = true; videoEl.muted = false;
  videoEl.style.display = 'none';
  document.body.appendChild(videoEl);

  guestStreams.set(senderId, { pc, stream:null, videoEl, name:senderName });

  pc.ontrack = ({ streams }) => {
    const s = guestStreams.get(senderId);
    if (s) { s.stream = streams[0]; videoEl.srcObject = streams[0]; }
    mostrarCanvas();
  };

  pc.onicecandidate = ({ candidate }) => {
    if (candidate) ws.send(JSON.stringify({ type:'ice-candidate', candidate, targetId:senderId }));
  };

  await pc.setRemoteDescription(new RTCSessionDescription(offer));
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  ws.send(JSON.stringify({ type:'answer', answer, targetId:senderId }));
}

// ── CANVAS COMPOSITOR ────────────────────────────────────────
function mostrarCanvas() {
  document.getElementById('waitMsg').style.display = 'none';
  const canvas = document.getElementById('outputCanvas');
  canvas.style.display = 'block';
  canvas.width  = 1280;
  canvas.height = 720;

  if (animFrame) return; // ya corriendo

  const ctx = canvas.getContext('2d');

  function draw() {
    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, 1280, 720);

    // Streams activos según lo que diga el director
    const sources = [];
    for (const [id, s] of guestStreams.entries()) {
      if (onAirIds.length === 0 || onAirIds.includes(id)) {
        if (s.videoEl && s.stream) sources.push(s);
      }
    }

    if (sources.length === 0) {
      ctx.fillStyle = '#111';
      ctx.fillRect(0, 0, 1280, 720);
      ctx.fillStyle = '#333';
      ctx.font = '28px Segoe UI';
      ctx.textAlign = 'center';
      ctx.fillText('Sin señal', 640, 360);
      animFrame = requestAnimationFrame(draw);
      return;
    }

    const layout = LAYOUTS.find(l => l.id === currentLayout) || LAYOUTS[2];
    const cols   = Math.min(layout.cols, sources.length);
    const rows   = Math.ceil(sources.length / cols);
    const w      = Math.floor(1280 / cols);
    const h      = Math.floor(720  / rows);
    const pad    = 3;

    sources.forEach((src, i) => {
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x   = col * w + pad;
      const y   = row * h + pad;
      const fw  = w - pad * 2;
      const fh  = h - pad * 2;
      try { ctx.drawImage(src.videoEl, x, y, fw, fh); } catch(e) {}
      // Nombre
      ctx.fillStyle = 'rgba(0,0,0,0.5)';
      ctx.fillRect(x, y + fh - 26, fw, 26);
      ctx.fillStyle = '#fff';
      ctx.font = `bold ${Math.max(11, Math.floor(h/20))}px Segoe UI`;
      ctx.textAlign = 'left';
      ctx.fillText(src.name, x + 7, y + fh - 7);
    });

    // Watermark
    ctx.fillStyle = 'rgba(255,255,255,0.12)';
    ctx.font = 'bold 16px Segoe UI';
    ctx.textAlign = 'right';
    ctx.fillText('STUDIO +', 1270, 712);

    animFrame = requestAnimationFrame(draw);
  }

  draw();
}

window.addEventListener('load', conectar);
</script>
</body>
</html>
