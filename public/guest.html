<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Studio + ‚Äî Invitado</title>
  <style>
    :root { --bg:#0f0f0f; --surface:#1a1a1a; --surface2:#111; --border:#2a2a2a; --accent:#e63; --blue:#6cf; --green:#3c3; --muted:#666; }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Segoe UI',sans-serif; background:var(--bg); color:#ddd; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:1rem; }
    .brand { text-align:center; margin-bottom:1.5rem; }
    .brand h1 { font-size:1.6rem; letter-spacing:2px; font-weight:700; color:#fff; }
    .brand h1 span { color:var(--accent); }
    .brand p { font-size:0.78rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-top:3px; }
    .card { background:var(--surface); border-radius:16px; padding:2rem; width:100%; max-width:460px; box-shadow:0 8px 32px rgba(0,0,0,0.5); }
    label { font-size:0.82rem; color:#888; display:block; margin-bottom:0.3rem; }
    input, select { width:100%; padding:0.75rem 1rem; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:#fff; font-size:0.9rem; margin-bottom:1rem; -webkit-appearance:none; }
    input:focus, select:focus { outline:none; border-color:var(--accent); }
    .divider { border:none; border-top:1px solid var(--border); margin:1rem 0; }
    .device-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem; }
    .btn-refresh { background:none; border:none; color:var(--muted); font-size:0.78rem; cursor:pointer; padding:0; width:auto; }
    .btn-refresh:hover { color:#fff; }
    .permission-hint { font-size:0.78rem; color:var(--accent); display:none; padding:0.5rem 0.75rem; background:#1a0a0a; border-radius:6px; border:1px solid #3a1a1a; margin-bottom:0.8rem; line-height:1.5; }
    .btn-join { width:100%; padding:0.85rem; border-radius:8px; border:none; font-size:1rem; font-weight:700; cursor:pointer; background:var(--accent); color:#fff; transition:all 0.2s; }
    .btn-join:disabled { background:var(--border); color:var(--muted); cursor:not-allowed; }
    .btn-join:hover:not(:disabled) { background:#ff4422; transform:translateY(-1px); }

    /* SALA DE ESPERA */
    #waitRoom { display:none; width:100%; max-width:460px; }
    .preview-wrap { aspect-ratio:16/9; background:#000; border-radius:12px; overflow:hidden; margin-bottom:1rem; position:relative; border:2px solid var(--border); }
    .preview-wrap video { width:100%; height:100%; object-fit:cover; display:block; }
    .on-air-indicator { display:none; position:absolute; top:10px; left:10px; background:var(--accent); color:#fff; font-size:0.7rem; font-weight:700; padding:3px 9px; border-radius:4px; text-transform:uppercase; letter-spacing:0.5px; }
    .on-air-indicator.show { display:block; animation:pulse 1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }
    .status-bar { background:var(--surface); border:1px solid var(--border); border-radius:8px; padding:0.65rem 1rem; margin-bottom:1rem; font-size:0.85rem; display:flex; align-items:center; gap:8px; }
    .dot { width:8px; height:8px; border-radius:50%; background:#444; flex-shrink:0; }
    .dot.ok   { background:var(--green); }
    .dot.warn { background:#fa0; animation:pulse 1.5s infinite; }
    .dot.err  { background:var(--accent); }
    .controls-row { display:flex; gap:0.65rem; margin-bottom:1rem; }
    .ctrl-btn { flex:1; padding:0.65rem; border-radius:8px; border:none; font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.15s; }
    #gBtnMute { background:#1a3a1a; border:1px solid #2a5a2a; color:var(--green); }
    #gBtnMute.muted { background:#3a1a1a; border:1px solid #6a2a2a; color:var(--accent); }
    #gBtnCam  { background:#0d1f2d; border:1px solid #1a3a4a; color:var(--blue); }
    #gBtnCam.camoff { background:#1a1a1a; border:1px solid var(--border); color:var(--muted); }
    #gBtnLeave { background:var(--surface2); border:1px solid var(--border); color:var(--muted); }
    #gBtnLeave:hover { border-color:var(--accent); color:var(--accent); }
    .mic-bar-bg { background:var(--surface2); border-radius:3px; height:5px; overflow:hidden; border:1px solid var(--border); }
    .mic-bar { height:5px; width:0%; background:linear-gradient(to right,var(--green),var(--accent)); border-radius:3px; transition:width 0.07s; }
    .room-badge { background:var(--surface2); border:1px solid var(--border); border-radius:8px; padding:0.5rem 0.85rem; font-size:0.8rem; color:var(--muted); text-align:center; margin-bottom:1rem; }
    .room-badge strong { color:var(--blue); }
    .kicked-msg { display:none; background:#1a0a0a; border:1px solid #6a2a2a; border-radius:10px; padding:1.5rem; text-align:center; color:var(--accent); }
  </style>
</head>
<body>

<div class="brand">
  <h1>STUDIO <span>+</span></h1>
  <p>Acceso de Invitado</p>
</div>

<!-- SETUP -->
<div class="card" id="setupCard">
  <label>Tu nombre</label>
  <input type="text" id="gNameInput" placeholder="Ej: Reportero en campo" maxlength="30" autocomplete="off">
  <hr class="divider">
  <div class="device-row">
    <label style="margin:0">C√°mara</label>
    <button class="btn-refresh" onclick="cargarDispositivos()">‚Üª Actualizar</button>
  </div>
  <select id="gCamSelect"><option value="">Cargando...</option></select>
  <label>Micr√≥fono</label>
  <select id="gMicSelect"><option value="">Cargando...</option></select>
  <div id="gPermHint" class="permission-hint">
    ‚ö†Ô∏è Permiso denegado. Clic en el candado üîí ‚Üí C√°mara y Micr√≥fono ‚Üí Permitir ‚Üí recargar.
  </div>
  <button class="btn-join" id="gBtnJoin" onclick="unirseComoGuest()" disabled>üì° Conectar al estudio</button>
</div>

<!-- SALA DE ESPERA / EN VIVO -->
<div id="waitRoom">
  <div class="room-badge">Sala: <strong id="gRoomDisplay">‚Äî</strong></div>
  <div class="preview-wrap">
    <video id="gMyVideo" autoplay muted playsinline></video>
    <div class="on-air-indicator" id="onAirIndicator">‚óè ON AIR</div>
  </div>
  <div class="status-bar">
    <span class="dot" id="gDot"></span>
    <span id="gStatusText">Conectando...</span>
  </div>
  <div class="controls-row">
    <button class="ctrl-btn" id="gBtnMute"  onclick="toggleGMute()">üéôÔ∏è Activo</button>
    <button class="ctrl-btn" id="gBtnCam"   onclick="toggleGCam()">üì∑ C√°mara ON</button>
    <button class="ctrl-btn" id="gBtnLeave" onclick="salirGuest()">‚Ü© Salir</button>
  </div>
  <div class="mic-bar-bg"><div class="mic-bar" id="gMicBar"></div></div>
</div>

<!-- EXPULSADO -->
<div class="kicked-msg" id="kickedMsg">
  <div style="font-size:2rem;margin-bottom:0.5rem">üö´</div>
  <div style="font-size:1rem;font-weight:700;margin-bottom:0.25rem">Has sido expulsado de la sala</div>
  <div style="font-size:0.85rem;color:#a55">El director ha terminado tu conexi√≥n</div>
  <button style="margin-top:1rem;padding:0.6rem 1.5rem;border-radius:8px;border:none;background:var(--accent);color:#fff;font-weight:700;cursor:pointer" onclick="location.reload()">Reconectar</button>
</div>

<script>
const params    = new URLSearchParams(location.search);
const roomParam = params.get('room') || '';

const STUN = { iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'}
]};

let ws, localStream, directorPc;
let gMuted = false, gCamOff = false;
let audioCtx, analyser, micAnimFrame;

// Pre-rellenar sala desde URL
if (roomParam) document.getElementById('gNameInput').placeholder = 'Tu nombre';

async function cargarDispositivos() {
  const camSel = document.getElementById('gCamSelect');
  const micSel = document.getElementById('gMicSelect');
  const hint   = document.getElementById('gPermHint');
  const btnJoin= document.getElementById('gBtnJoin');
  camSel.innerHTML = micSel.innerHTML = '<option value="">Cargando...</option>';
  btnJoin.disabled = true; hint.style.display = 'none';
  try {
    const tmp = await navigator.mediaDevices.getUserMedia({ video:true, audio:true });
    tmp.getTracks().forEach(t => t.stop());
    await new Promise(r => setTimeout(r, 400));
    const devices
