<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Studio + ‚Äî Director</title>
  <style>
    :root {
      --bg:#0a0a0a; --surface:#161616; --surface2:#111;
      --border:#252525; --accent:#e63; --blue:#6cf;
      --green:#3c3; --yellow:#fa0; --text:#ddd; --muted:#666;
    }
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:'Segoe UI',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

    .topbar { background:var(--surface); border-bottom:1px solid var(--border); padding:0.75rem 1.5rem; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
    .topbar-brand h1 { font-size:1.2rem; letter-spacing:2px; color:#fff; }
    .topbar-brand h1 span { color:var(--accent); }
    .topbar-brand p { font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; }
    .topbar-right { display:flex; align-items:center; gap:1rem; }
    .status-pill { display:flex; align-items:center; gap:6px; font-size:0.82rem; background:var(--surface2); border:1px solid var(--border); border-radius:20px; padding:0.35rem 0.85rem; }
    .dot { width:8px; height:8px; border-radius:50%; background:#444; flex-shrink:0; }
    .dot.live { background:var(--accent); animation:pulse 1s infinite; }
    .dot.ok   { background:var(--green); }
    .dot.warn { background:var(--yellow); animation:pulse 1.5s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.2} }
    .btn-sm { padding:0.4rem 0.9rem; border-radius:6px; border:none; font-size:0.82rem; font-weight:600; cursor:pointer; transition:all 0.15s; }
    .btn-danger { background:#3a1a1a; border:1px solid #6a2a2a; color:var(--accent); }
    .btn-danger:hover { background:#4a2020; }

    .main { display:grid; grid-template-columns:1fr 320px; gap:1rem; padding:1rem 1.5rem; height:calc(100vh - 57px); overflow:hidden; }

    .guests-panel { display:flex; flex-direction:column; gap:1rem; overflow-y:auto; }
    .section-title { font-size:0.72rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:0.5rem; }
    .guest-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px, 1fr)); gap:0.75rem; }

    .guest-card { background:var(--surface); border:2px solid var(--border); border-radius:12px; overflow:hidden; transition:border-color 0.2s; }
    .guest-card.on-air { border-color:var(--accent); }
    .guest-video-wrap { position:relative; aspect-ratio:16/9; background:#000; }
    .guest-video-wrap video { width:100%; height:100%; object-fit:cover; display:block; }
    .guest-overlay { position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.65); display:flex; align-items:center; justify-content:center; font-size:2rem; transition:opacity 0.2s; pointer-events:none; }
    .guest-card.on-air .guest-overlay { opacity:0; }
    .on-air-badge { position:absolute; top:8px; left:8px; background:var(--accent); color:#fff; font-size:0.65rem; font-weight:700; padding:2px 7px; border-radius:4px; text-transform:uppercase; letter-spacing:0.5px; display:none; }
    .guest-card.on-air .on-air-badge { display:block; }
    .guest-controls { padding:0.65rem 0.85rem; display:flex; align-items:center; gap:0.5rem; }
    .guest-name { font-size:0.88rem; font-weight:600; color:#fff; flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .ctrl-icon { width:30px; height:30px; border-radius:6px; border:none; cursor:pointer; font-size:0.9rem; display:flex; align-items:center; justify-content:center; transition:all 0.15s; flex-shrink:0; }
    .btn-toggle { background:#1a3a1a; border:1px solid #2a5a2a; color:var(--green); }
    .btn-toggle.active { background:var(--accent); border-color:#c52; color:#fff; }
    .btn-mute-guest { background:var(--surface2); border:1px solid var(--border); color:var(--muted); }
    .btn-mute-guest.muted { background:#3a1a1a; border-color:#6a2a2a; color:var(--accent); }
    .btn-kick { background:var(--surface2); border:1px solid var(--border); color:var(--muted); }
    .btn-kick:hover { background:#3a1a1a; border-color:#6a2a2a; color:var(--accent); }
    .empty-guests { background:var(--surface); border:1px dashed var(--border); border-radius:12px; padding:2.5rem; text-align:center; color:var(--muted); font-size:0.88rem; }
    .empty-guests .empty-icon { font-size:2rem; margin-bottom:0.5rem; }

    .control-panel { display:flex; flex-direction:column; gap:0.75rem; overflow-y:auto; }
    .ctrl-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:1rem; }
    .ctrl-card h3 { font-size:0.75rem; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:0.85rem; }

    .my-cam-wrap { aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; margin-bottom:0.75rem; }
    .my-cam-wrap video { width:100%; height:100%; object-fit:cover; }
    .my-cam-controls { display:flex; gap:0.5rem; }
    .my-cam-controls button { flex:1; padding:0.55rem; border-radius:7px; border:none; font-size:0.8rem; font-weight:600; cursor:pointer; transition:all 0.15s; }
    #btnDirMute { background:#1a3a1a; border:1px solid #2a5a2a; color:var(--green); }
    #btnDirMute.muted { background:#3a1a1a; border:1px solid #6a2a2a; color:var(--accent); }
    #btnDirCam  { background:#0d1f2d; border:1px solid #1a3a4a; color:var(--blue); }
    #btnDirCam.camoff { background:#1a1a1a; border:1px solid var(--border); color:var(--muted); }

    .layout-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:0.4rem; }
    .layout-btn { aspect-ratio:16/9; border-radius:6px; border:2px solid var(--border); background:var(--surface2); cursor:pointer; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:2px; transition:all 0.15s; padding:4px; }
    .layout-btn:hover { border-color:var(--blue); }
    .layout-btn.active { border-color:var(--accent); background:#1a0f0a; }
    .layout-icon { display:grid; width:100%; gap:2px; }
    .layout-icon .cell { background:var(--muted); border-radius:2px; height:10px; }
    .layout-label { font-size:0.58rem; color:var(--muted); text-align:center; margin-top:2px; }

    .program-mini { aspect-ratio:16/9; background:#000; border-radius:8px; overflow:hidden; margin-bottom:0.75rem; position:relative; border:2px solid var(--accent); }
    .program-mini canvas { width:100%; height:100%; display:block; }
    .program-mini-label { position:absolute; top:6px; left:8px; background:var(--accent); color:#fff; font-size:0.6rem; font-weight:700; padding:2px 6px; border-radius:3px; text-transform:uppercase; }
    .btn-open-program { width:100%; padding:0.6rem; border-radius:7px; border:none; font-size:0.82rem; font-weight:600; cursor:pointer; background:var(--accent); color:#fff; transition:all 0.15s; }
    .btn-open-program:hover { background:#ff4422; }

    .link-copy { background:var(--surface2); border:1px solid var(--border); border-radius:7px; padding:0.65rem 0.85rem; font-size:0.75rem; word-break:break-all; color:var(--blue); cursor:pointer; line-height:1.5; }
    .link-copy:hover { background:#0d1a2a; }

    .mic-bar-bg { background:var(--surface2); border-radius:3px; height:5px; overflow:hidden; border:1px solid var(--border); margin-top:0.5rem; }
    .mic-bar { height:5px; width:0%; background:linear-gradient(to right,var(--green),var(--accent)); border-radius:3px; transition:width 0.07s; }

    /* SETUP OVERLAY */
    #setupOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.95); display:flex; align-items:center; justify-content:center; z-index:200; overflow-y:auto; padding:1rem; }
    .setup-card { background:var(--surface); border-radius:16px; padding:2.5rem; width:100%; max-width:400px; box-shadow:0 16px 48px rgba(0,0,0,0.8); }
    .setup-brand { text-align:center; margin-bottom:2rem; }
    .setup-brand h2 { font-size:1.6rem; letter-spacing:2px; font-weight:700; }
    .setup-brand h2 span { color:var(--accent); }
    .setup-brand p { font-size:0.78rem; color:var(--muted); margin-top:4px; }
    .setup-label { font-size:0.82rem; color:#888; display:block; margin-bottom:0.3rem; }
    .setup-input { width:100%; padding:0.75rem 1rem; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:#fff; font-size:0.95rem; margin-bottom:1rem; }
    .setup-input:focus { outline:none; border-color:var(--accent); }
    .device-row { display:flex; justify-content:space-between; align-items:center; margin-bottom:0.3rem; }
    .btn-refresh-sm { background:none; border:none; color:var(--muted); font-size:0.78rem; cursor:pointer; padding:0; width:auto; }
    .btn-refresh-sm:hover { color:#fff; }
    .permission-hint { font-size:0.78rem; color:var(--accent); display:none; padding:0.5rem 0.75rem; background:#1a0a0a; border-radius:6px; border:1px solid #3a1a1a; margin-bottom:0.8rem; line-height:1.5; }
    .setup-select { width:100%; padding:0.75rem 1rem; border-radius:8px; border:1px solid var(--border); background:var(--surface2); color:#fff; font-size:0.9rem; margin-bottom:1rem; -webkit-appearance:none; }
    .btn-enter { width:100%; padding:0.85rem; border-radius:8px; border:none; font-size:1rem; font-weight:700; cursor:pointer; transition:all 0.2s; margin-top:0.25rem; }
    .btn-enter-perms { background:#0d1f2d; border:1px solid #1a3a4a; color:var(--blue); margin-bottom:1rem; }
    .btn-enter-perms:hover { background:#112233; }
    .btn-enter-main { background:var(--accent); color:#fff; }
    .btn-enter-main:disabled { background:var(--border); color:var(--muted); cursor:not-allowed; }
    .btn-enter-main:hover:not(:disabled) { background:#ff4422; }
    .divider { border:none; border-top:1px solid var(--border); margin:1rem 0; }
    #deviceSelectors { display:none; }
  </style>
</head>
<body>

<!-- SETUP OVERLAY -->
<div id="setupOverlay">
  <div class="setup-card">
    <div class="setup-brand">
      <h2>STUDIO <span>+</span></h2>
      <p>Panel de Director</p>
    </div>

    <label class="setup-label">Nombre de sala</label>
    <input class="setup-input" type="text" id="roomInput" placeholder="Ej: produccion-live" autocomplete="off">

    <label class="setup-label">Contrase√±a de sala</label>
    <input class="setup-input" type="password" id="passInput" placeholder="Clave de acceso director">

    <label class="setup-label">Tu nombre</label>
    <input class="setup-input" type="text" id="nameInput" placeholder="Ej: Carlos ‚Äî Director" autocomplete="off">

    <hr class="divider">

    <!-- Bot√≥n de permisos ‚Äî primer paso -->
    <button class="btn-enter btn-enter-perms" onclick="cargarDispositivos()">
      üì∑ Solicitar acceso a c√°mara y micr√≥fono
    </button>

    <div id="permissionHint" class="permission-hint">
      ‚ö†Ô∏è Permiso denegado. Clic en el candado üîí ‚Üí Permitir c√°mara y micr√≥fono ‚Üí recargar.
    </div>

    <!-- Selectores ‚Äî aparecen solo tras permiso -->
    <div id="deviceSelectors">
      <div class="device-row">
        <label class="setup-label" style="margin:0">C√°mara</label>
        <button class="btn-refresh-sm" onclick="cargarDispositivos()">‚Üª Actualizar</button>
      </div>
      <select class="setup-select" id="camSelect"><option value="">‚Äî</option></select>

      <label class="setup-label">Micr√≥fono</label>
      <select class="setup-select" id="micSelect"><option value="">‚Äî</option></select>
    </div>

    <button class="btn-enter btn-enter-main" id="btnEnter" onclick="iniciarDirector()" disabled>
      üé¨ Entrar al estudio
    </button>
  </div>
</div>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-brand">
    <h1>STUDIO <span>+</span></h1>
    <p id="roomLabel">Director</p>
  </div>
  <div class="topbar-right">
    <div class="status-pill">
      <span class="dot" id="dot"></span>
      <span id="statusText">Esperando...</span>
    </div>
    <button class="btn-sm btn-danger" onclick="salirEstudio()">‚Ü© Salir</button>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- GUESTS PANEL -->
  <div class="guests-panel">
    <div class="section-title">Invitados en sala (<span id="guestCount">0</span>/5)</div>
    <div class="guest-grid" id="guestGrid">
      <div class="empty-guests">
        <div class="empty-icon">üì°</div>
        <div>Esperando invitados...</div>
        <div style="font-size:0.78rem;margin-top:0.3rem;color:#555">Comparte el enlace del panel derecho</div>
      </div>
    </div>
  </div>

  <!-- CONTROL PANEL -->
  <div class="control-panel">

    <div class="ctrl-card">
      <h3>Mi c√°mara (Director)</h3>
      <div class="my-cam-wrap">
        <video id="myVideo" autoplay muted playsinline></video>
      </div>
      <div class="my-cam-controls">
        <button id="btnDirMute" onclick="toggleDirMute()">üéôÔ∏è Activo</button>
        <button id="btnDirCam"  onclick="toggleDirCam()">üì∑ C√°mara ON</button>
      </div>
      <div class="mic-bar-bg"><div class="mic-bar" id="micBar"></div></div>
    </div>

    <div class="ctrl-card">
      <h3>Layout del programa</h3>
      <div class="layout-grid" id="layoutGrid"></div>
    </div>

    <div class="ctrl-card">
      <h3>Program Monitor</h3>
      <div class="program-mini">
        <canvas id="programCanvas"></canvas>
        <div class="program-mini-label">PROGRAM</div>
      </div>
      <button class="btn-open-program" onclick="abrirPrograma()">üñ•Ô∏è Abrir ventana para OBS</button>
    </div>

    <div class="ctrl-card">
      <h3>Enlace para invitados</h3>
      <div class="link-copy" id="guestLink" onclick="copiarEnlaceInvitado()">
        üìã Clic para copiar enlace
        <div style="color:#4a8a4a;font-size:0.7rem;margin-top:3px" id="guestLinkUrl"></div>
      </div>
    </div>

  </div>
</div>

<script>
const STUN = { iceServers:[
  {urls:'stun:stun.l.google.com:19302'},
  {urls:'stun:stun1.l.google.com:19302'}
]};

const LAYOUTS = [
  { id:'full',  label:'Full',   cols:1, rows:1 },
  { id:'side2', label:'2 lado', cols:2, rows:1 },
  { id:'grid4', label:'Grid 4', cols:2, rows:2 },
  { id:'grid6', label:'Grid 6', cols:3, rows:2 }
];

let ws, localStream, myRoom, myName, myPass;
let dirMuted = false, dirCamOff = false;
let currentLayout = 'grid4';
let audioCtx, analyser, micAnimFrame;
let programWindow = null;
const guests = new Map();

// ‚îÄ‚îÄ CARGAR DISPOSITIVOS (requiere clic) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function cargarDispositivos() {
  const hint = document.getElementById('permissionHint');
  hint.style.display = 'none';
  let tempStream = null;
  try {
    tempStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
    const devices = await navigator.mediaDevices.enumerateDevices();
    tempStream.getTracks().forEach(t => t.stop());
    tempStream = null;

    const cameras = devices.filter(d => d.kind === 'videoinput');
    const mics    = devices.filter(d => d.kind === 'audioinput');

    const camSel = document.getElementById('camSelect');
    const micSel = document.getElementById('micSelect');

    camSel.innerHTML = '';
    cameras.forEach((d, i) => {
      const o = document.createElement('option');
      o.value = d.deviceId;
      o.textContent = (d.label && d.label.trim()) ? d.label : `C√°mara ${i + 1}`;
      camSel.appendChild(o);
    });

    micSel.innerHTML = '';
    mics.forEach((d, i) => {
      const o = document.createElement('option');
      o.value = d.deviceId;
      o.textContent = (d.label && d.label.trim()) ? d.label : `Micr√≥fono ${i + 1}`;
      micSel.appendChild(o);
    });

    document.getElementById('deviceSelectors').style.display = 'block';
    document.getElementById('btnEnter').disabled = false;

  } catch(e) {
    if (tempStream) tempStream.getTracks().forEach(t => t.stop());
    if (e.name === 'NotAllowedError') {
      hint.style.display = 'block';
    } else if (e.name === 'NotFoundError') {
      document.getElementById('camSelect').innerHTML = '<option value="">Sin c√°mara conectada</option>';
      document.getElementById('micSelect').innerHTML = '<option value="">Sin micr√≥fono conectado</option>';
      document.getElementById('deviceSelectors').style.display = 'block';
    } else {
      alert('Error al acceder a dispositivos: ' + e.message);
    }
  }
}

// ‚îÄ‚îÄ INICIAR DIRECTOR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function iniciarDirector() {
  myRoom = document.getElementById('roomInput').value.trim().toLowerCase()
    .replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'') || 'studio-plus';
  myPass = document.getElementById('passInput').value.trim();
  myName = document.getElementById('nameInput').value.trim() || 'Director';

  if (!myPass) { alert('Ingresa una contrase√±a para la sala'); return; }

  const camId = document.getElementById('camSelect').value;
  const micId = document.getElementById('micSelect').value;

  try {
    localStream = await navigator.mediaDevices.getUserMedia({
      video: camId ? { deviceId:{ exact:camId } } : true,
      audio: micId
        ? { deviceId:{ exact:micId }, echoCancellation:false, noiseSuppression:false }
        : { echoCancellation:false, noiseSuppression:false }
    });
  } catch(e) { alert('No se pudo acceder a c√°mara/micr√≥fono: ' + e.message); return; }

  document.getElementById('myVideo').srcObject = localStream;
  iniciarVisualizador();
  renderLayouts();

  const guestUrl = `${location.origin}/guest.html?room=${myRoom}`;
  document.getElementById('guestLinkUrl').textContent = guestUrl;
  document.getElementById('guestLink').dataset.link = guestUrl;
  document.getElementById('roomLabel').textContent = 'Director ¬∑ ' + myRoom;

  conectarWS();
  document.getElementById('setupOverlay').style.display = 'none';
  iniciarCompositor();
}

// ‚îÄ‚îÄ WEBSOCKET ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function conectarWS() {
  const protocol = location.protocol === 'https:' ? 'wss' : 'ws';
  ws = new WebSocket(`${protocol}://${location.host}/signal/${myRoom}?name=${encodeURIComponent(myName)}&role=director&password=${encodeURIComponent(myPass)}`);

  ws.onopen = () => {
    setStatus('En l√≠nea ¬∑ ' + myRoom, 'ok');
    ws.send(JSON.stringify({ type:'get-guests' }));
  };

  ws.onmessage = async ({ data }) => {
    const msg = JSON.parse(data);
    switch(msg.type) {
      case 'guests-list':
        for (const g of msg.guests) await conectarConGuest(g.id, g.name);
        break;
      case 'guest-joined':
        await conectarConGuest(msg.guestId, msg.name);
        break;
      case 'guest-left':
        removerGuest(msg.guestId);
        break;
      case 'answer':
        if (guests.has(msg.senderId)) {
          await guests.get(msg.senderId).pc.setRemoteDescription(
            new RTCSessionDescription(msg.answer)
          );
        }
        break;
      case 'ice-candidate':
        if (guests.has(msg.senderId)) {
          try {
            await guests.get(msg.senderId).pc.addIceCandidate(
              new RTCIceCandidate(msg.candidate)
            );
          } catch(e) {}
        }
        break;
    }
  };

  ws.onclose = () => setStatus('Desconectado', 'warn');
  ws.onerror = () => setStatus('Error WS', 'warn');
}

// ‚îÄ‚îÄ CONECTAR CON GUEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function conectarConGuest(guestId, guestName) {
  if (guests.has(guestId)) return;

  const pc = new RTCPeerConnection(STUN);
  guests.set(guestId, { name:guestName, pc, stream:null, onAir:true, muted:false, videoEl:null });

  localStream.getTracks().forEach(t => pc.addTrack(t, localStream));

  pc.ontrack = ({ streams }) => {
    const g = guests.get(guestId);
    if (!g) return;
    g.stream = streams[0];
    if (g.videoEl) g.videoEl.srcObject = streams[0];
    renderGuests();
  };

  pc.onicecandidate = ({ candidate }) => {
    if (candidate) ws.send(JSON.stringify({ type:'ice-candidate', candidate, targetId:guestId }));
  };

  pc.onconnectionstatechange = () => {
    if (['failed','disconnected','closed'].includes(pc.connectionState)) removerGuest(guestId);
  };

  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  ws.send(JSON.stringify({ type:'offer', offer, targetId:guestId }));

  renderGuests();
  actualizarConteo();
}

// ‚îÄ‚îÄ RENDER GUESTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderGuests() {
  const grid = document.getElementById('guestGrid');

  if (guests.size === 0) {
    grid.innerHTML = `<div class="empty-guests"><div class="empty-icon">üì°</div><div>Esperando invitados...</div></div>`;
    return;
  }

  // Limpiar placeholder si existe
  const placeholder = grid.querySelector('.empty-guests');
  if (placeholder) placeholder.remove();

  for (const [id, g] of guests.entries()) {
    let card = document.getElementById('gcard-' + id);

    if (!card) {
      card = document.createElement('div');
      card.className = 'guest-card' + (g.onAir ? ' on-air' : '');
      card.id = 'gcard-' + id;
      card.innerHTML = `
        <div class="guest-video-wrap">
          <video id="gvideo-${id}" autoplay playsinline></video>
          <div class="guest-overlay">üé•</div>
          <div class="on-air-badge">‚óè ON AIR</div>
        </div>
        <div class="guest-controls">
          <span class="guest-name">${g.name}</span>
          <button class="ctrl-icon btn-toggle ${g.onAir ? 'active' : ''}"
            title="${g.onAir ? 'Quitar del aire' : 'Poner al aire'}"
            onclick="toggleOnAir('${id}')">üì∫</button>
          <button class="ctrl-icon btn-mute-guest ${g.muted ? 'muted' : ''}"
            title="${g.muted ? 'Activar audio' : 'Silenciar'}"
            onclick="toggleGuestMute('${id}')">üéôÔ∏è</button>
          <button class="ctrl-icon btn-kick"
            title="Expulsar de la sala"
            onclick="kickGuest('${id}')">‚úï</button>
        </div>
      `;
      grid.appendChild(card);

      const videoEl = document.getElementById('gvideo-' + id);
      g.videoEl = videoEl;
      if (g.stream) videoEl.srcObject = g.stream;

    } else {
      card.className = 'guest-card' + (g.onAir ? ' on-air' : '');
      const toggleBtn = card.querySelector('.btn-toggle');
      if (toggleBtn) {
        toggleBtn.className = `ctrl-icon btn-toggle ${g.onAir ? 'active' : ''}`;
        toggleBtn.title = g.onAir ? 'Quitar del aire' : 'Poner al aire';
      }
      const muteBtn = card.querySelector('.btn-mute-guest');
      if (muteBtn) {
        muteBtn.className = `ctrl-icon btn-mute-guest ${g.muted ? 'muted' : ''}`;
      }
    }
  }
}

// ‚îÄ‚îÄ CONTROLES GUEST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleOnAir(guestId) {
  const g = guests.get(guestId);
  if (!g) return;
  g.onAir = !g.onAir;
  renderGuests();
  const onAirIds = [...guests.entries()].filter(([,g]) => g.onAir).map(([id]) => id);
  enviarAPrograma({ type:'scene-update', onAirIds, layout:currentLayout });
}

function toggleGuestMute(guestId) {
  const g = guests.get(guestId);
  if (!g) return;
  g.muted = !g.muted;
  ws.send(JSON.stringify({ type:'remote-mute', guestId, muted:g.muted }));
  renderGuests();
}

function kickGuest(guestId) {
  if (!confirm('¬øExpulsar a este participante de la sala?')) return;
  ws.send(JSON.stringify({ type:'kick-guest', guestId }));
  removerGuest(guestId);
}

function removerGuest(guestId) {
  const g = guests.get(guestId);
  if (!g) return;
  g.pc?.close();
  document.getElementById('gcard-' + guestId)?.remove();
  guests.delete(guestId);
  if (guests.size === 0) {
    document.getElementById('guestGrid').innerHTML =
      `<div class="empty-guests"><div class="empty-icon">üì°</div><div>Esperando invitados...</div></div>`;
  }
  actualizarConteo();
}

function actualizarConteo() {
  document.getElementById('guestCount').textContent = guests.size;
}

// ‚îÄ‚îÄ MI C√ÅMARA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleDirMute() {
  dirMuted = !dirMuted;
  localStream.getAudioTracks().forEach(t => { t.enabled = !dirMuted; });
  const btn = document.getElementById('btnDirMute');
  btn.textContent = dirMuted ? 'üîá Silenciado' : 'üéôÔ∏è Activo';
  btn.classList.toggle('muted', dirMuted);
}

function toggleDirCam() {
  dirCamOff = !dirCamOff;
  localStream.getVideoTracks().forEach(t => { t.enabled = !dirCamOff; });
  const btn = document.getElementById('btnDirCam');
  btn.textContent = dirCamOff ? 'üö´ C√°mara OFF' : 'üì∑ C√°mara ON';
  btn.classList.toggle('camoff', dirCamOff);
}

// ‚îÄ‚îÄ LAYOUTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLayouts() {
  const grid = document.getElementById('layoutGrid');
  grid.innerHTML = '';
  LAYOUTS.forEach(l => {
    const btn = document.createElement('div');
    btn.className = 'layout-btn' + (l.id === currentLayout ? ' active' : '');
    btn.onclick = () => seleccionarLayout(l.id);

    const icon = document.createElement('div');
    icon.className = 'layout-icon';
    icon.style.gridTemplateColumns = `repeat(${l.cols},1fr)`;
    icon.style.gridTemplateRows    = `repeat(${l.rows},1fr)`;
    icon.style.gap = '2px';
    for (let i = 0; i < l.cols * l.rows; i++) {
      const cell = document.createElement('div');
      cell.className = 'cell';
      icon.appendChild(cell);
    }
    btn.appendChild(icon);

    const label = document.createElement('div');
    label.className = 'layout-label';
    label.textContent = l.label;
    btn.appendChild(label);

    grid.appendChild(btn);
  });
}

function seleccionarLayout(layoutId) {
  currentLayout = layoutId;
  renderLayouts();
  const onAirIds = [...guests.entries()].filter(([,g]) => g.onAir).map(([id]) => id);
  enviarAPrograma({ type:'scene-update', onAirIds, layout:currentLayout });
}

// ‚îÄ‚îÄ COMPOSITOR MINI (preview en panel) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function iniciarCompositor() {
  const canvas = document.getElementById('programCanvas');
  const ctx    = canvas.getContext('2d');
  canvas.width  = 1280;
  canvas.height = 720;

  function drawFrame() {
    ctx.fillStyle = '#0a0a0a';
    ctx.fillRect(0, 0, 1280, 720);

    const sources = [];
    const myVideo = document.getElementById('myVideo');
    if (myVideo.srcObject) sources.push({ el:myVideo, name:myName });

    for (const [, g] of guests.entries()) {
      if (g.onAir && g.videoEl && g.stream) {
        sources.push({ el:g.videoEl, name:g.name });
      }
    }

    if (sources.length === 0) {
      ctx.fillStyle = '#333';
      ctx.font = '28px Segoe UI';
      ctx.textAlign = 'center';
      ctx.fillText('Sin se√±al de video', 640, 360);
      requestAnimationFrame(drawFrame);
      return;
    }

    const layout = LAYOUTS.find(l => l.id === currentLayout) || LAYOUTS[2];
    const cols   = Math.min(layout.cols, sources.length);
    const rows   = Math.ceil(sources.length / cols);
    const w      = Math.floor(1280 / cols);
    const h      = Math.floor(720  / rows);
    const pad    = 4;

    sources.forEach((src, i) => {
      const col = i % cols;
      const row = Math.floor(i / cols);
      const x   = col * w + pad;
      const y   = row * h + pad;
      const fw  = w - pad * 2;
      const fh  = h - pad * 2;
      try { ctx.drawImage(src.el, x, y, fw, fh); } catch(e) {}
      ctx.fillStyle = 'rgba(0,0,0,0.55)';
      ctx.fillRect(x, y + fh - 28, fw, 28);
      ctx.fillStyle = '#fff';
      ctx.font = `bold ${Math.max(12, Math.floor(h/18))}px Segoe UI`;
      ctx.textAlign = 'left';
      ctx.fillText(src.name, x + 8, y + fh - 8);
    });

    ctx.fillStyle = 'rgba(255,255,255,0.15)';
    ctx.font = 'bold 18px Segoe UI';
    ctx.textAlign = 'right';
    ctx.fillText('STUDIO +', 1270, 710);

    requestAnimationFrame(drawFrame);
  }

  drawFrame();
}

// ‚îÄ‚îÄ VENTANA PROGRAMA (OBS) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function abrirPrograma() {
  const url = `${location.origin}/program.html?room=${myRoom}&pass=${encodeURIComponent(myPass)}`;
  programWindow = window.open(url, 'StudioPlusProgram', 'width=1280,height=720,resizable=yes');
}

function enviarAPrograma(data) {
  if (programWindow && !programWindow.closed) {
    programWindow.postMessage(data, location.origin);
  }
}

// ‚îÄ‚îÄ SALIR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function salirEstudio() {
  if (!confirm('¬øSalir del estudio?')) return;
  if (localStream) localStream.getTracks().forEach(t => t.stop());
  cancelAnimationFrame(micAnimFrame);
  if (audioCtx) { audioCtx.close(); audioCtx = null; }
  guests.forEach(g => g.pc?.close());
  guests.clear();
  if (ws && ws.readyState === WebSocket.OPEN) ws.close();
  location.reload();
}

// ‚îÄ‚îÄ VISUALIZADOR MIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function iniciarVisualizador() {
  audioCtx  = new AudioContext();
  analyser  = audioCtx.createAnalyser(); analyser.fftSize = 512;
  const src = audioCtx.createMediaStreamSource(localStream);
  src.connect(analyser);
  const buf = new Uint8Array(analyser.frequencyBinCount);
  function tick() {
    analyser.getByteFrequencyData(buf);
    const pct = Math.min(100, Math.round(buf.reduce((a,b)=>a+b,0)/buf.length*3));
    document.getElementById('micBar').style.width = pct + '%';
    micAnimFrame = requestAnimationFrame(tick);
  }
  tick();
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setStatus(text, type) {
  document.getElementById('statusText').textContent = text;
  document.getElementById('dot').className = 'dot' + (type ? ' ' + type : '');
}

function copiarEnlaceInvitado() {
  const link = document.getElementById('guestLink').dataset.link;
  navigator.clipboard.writeText(link).then(() => {
    document.getElementById('guestLink').childNodes[0].textContent = '‚úÖ ¬°Enlace copiado! ';
    setTimeout(() => {
      document.getElementById('guestLink').childNodes[0].textContent = 'üìã Clic para copiar enlace\n';
    }, 2500);
  });
}

navigator.mediaDevices.addEventListener('devicechange', cargarDispositivos);
</script>
</body>
</html>
